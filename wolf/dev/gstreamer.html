<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>GStreamer :: Games On Whales</title>
    <meta name="generator" content="Antora 3.0.1">
<link rel="stylesheet" href="../../_/css/site.css">
<link rel="stylesheet" href="../../_/css/vendor/tabs.css">
<link rel="stylesheet" href="../../_/css/site-extra.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
    <div class="fancy-stripe"></div>
    <nav class="navbar">
        <div class="navbar-brand">
            <a class="navbar-item" href="../..">Games On Whales</a>
                <div class="navbar-item search hide-for-print">
                    <div id="search-field" class="field">
                        <input id="search-input" type="text" placeholder="Search the docs">
                    </div>
                </div>
            <button class="navbar-burger" data-target="topbar-nav">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
        <div id="topbar-nav" class="navbar-menu">
            <div class="navbar-end">
                <div class="navbar-item has-dropdown is-hoverable">
                    <a class="navbar-link" href="#">Projects</a>
                    <div class="navbar-dropdown">
                        <a class="navbar-item" href="https://games-on-whales.github.io/gow/">Games on Whales</a>
                        <a class="navbar-item" href="https://games-on-whales.github.io/wolf">Wolf</a>
                    </div>
                </div>
                <div class="navbar-item has-dropdown is-hoverable">
                    <a class="navbar-link" href="#">Community</a>
                    <div class="navbar-dropdown">
                        <a class="navbar-item" href="https://discord.gg/kRGUDHNHt2">Discord</a>
                        <a class="navbar-item" href="https://github.com/games-on-whales">Github</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>
</header>
<div class="body">
<div class="nav-container" data-component="wolf" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">wolf</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">User guide</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../user/quickstart.html">Quickstart</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../user/configuration.html">Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../user/gstreamer.html">Gstreamer</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Developer guide</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="code-structure.html">Code Structure</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="gstreamer.html">GStreamer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../protocols/index.html">Moonlight Protocols</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../protocols/http-pairing.html">HTTP/S Pairing</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../protocols/rtsp.html">RTSP</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">RTP</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../protocols/rtp-video.html">Video (H.264/HEVC)</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../protocols/rtp-opus.html">Audio (Opus)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../protocols/control-specs.html">Control (via ENET)</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../protocols/input-data.html">Input Data</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">wolf</span>
    <span class="version">default</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../gow/index.html">gow</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../gow/index.html">default</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../index.html">wolf</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">default</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../gow/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">wolf</a></li>
    <li>Developer guide</li>
    <li><a href="gstreamer.html">GStreamer</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/games-on-whales/wolf/edit/main/docs/modules/dev/pages/gstreamer.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">GStreamer</h1>
<div id="preamble">
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
GStreamer is a library for constructing graphs of media-handling components.
The applications it supports range from simple Ogg/Vorbis playback, audio/video streaming to complex audio (mixing) and video (non-linear editing) processing.
</blockquote>
<div class="attribution">
&#8212; <a href="https://gstreamer.freedesktop.org/">gstreamer.freedesktop.org</a>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_overview"><a class="anchor" href="#_overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We implemented two custom plugins (one for video and one for audio) in order to turn a stream of bytes into a stream of valid Moonlight RTP packets.<br>
This allows users to be able to compose Gstreamer pipelines in any form or shape and, near the end, plug our plugin so that it can be streamed to Moonlight.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_plugin"><a class="anchor" href="#_the_plugin"></a>The plugin</h2>
<div class="sectionbody">
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/mermaid/svg/eNpLy8kvT85ILCpR8AniUlAIi3bNS85PSU1RKC4pSk3MjVXQ1VUozszLBtJ2CgHRQSEBCrn5-Xk5mekZJQoFiZU5-YkpqUUQZUXJYFWh0aEuAWBNsQDIuB67" alt="Our plugin sits between the encoded bitestream and a downstream UDP sink that will send the RTP packets to Moonlight">
</div>
<div class="title">Figure 1. Our plugin sits between the encoded bitestream and a downstream UDP sink that will send the RTP packets to Moonlight</div>
</div>
<div class="paragraph">
<p>The basic flow is the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The plugin receives a <code>GstBuffer</code> of binary data: the encoded video or audio stream into a format that can be decoded back by the Moonlight client.</p>
</li>
<li>
<p>We&#8217;ll split this into a <code>GstBufferList</code> of valid RTP packets following the Moonlight specifications; this includes:</p>
<div class="ulist">
<ul>
<li>
<p>split the original buffer into a set of correctly sized chunks</p>
</li>
<li>
<p>Encrypt the chunks when enabled</p>
</li>
<li>
<p>add RTP headers to each chunk</p>
</li>
<li>
<p>create additional RTP packets with the FEC information</p>
</li>
</ul>
</div>
</li>
<li>
<p>Push the resulting list downstream</p>
</li>
</ul>
</div>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/mermaid/svg/eNpLy8kvT85ILCpR8AniUnCMLstMSc0vSS0uKS5KjlXQ1bVTcIKIFScn5qRCRJwhIsn5eWWpRSUQMZfoCiMzk9Q8qCbX6KKSgtz8_LyczPSMkoLEyniwFoikW3RpSkFxZl52LAC2yytV" alt="An example pipeline for *video* encoding and streaming">
</div>
<div class="title">Figure 2. An example pipeline for <strong>video</strong> encoding and streaming</div>
</div>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/mermaid/svg/eNoty00KgCAQhuF9p_ACXSHod9WqrUSIWUrmyDgW3T5o2j7v920ebm0VkhinQtRS5dUBmUQJ9SzKshINm4ZwGSS2lg0VGYZOQszJhP_TS6R4AgTvdktRPcu35zjIvMbkwjG_rIcrmA==" alt="An example pipeline for *audio* encoding and streaming">
</div>
<div class="title">Figure 3. An example pipeline for <strong>audio</strong> encoding and streaming</div>
</div>
<div class="paragraph">
<p>This flow is general enough to enable us to use the same plugin for both H.264 and HEVC (and any other encoder that will be supported in future).
Downstream, it&#8217;s also trivial to switch between UDP/TCP or even a complete different delivery method if needed.</p>
</div>
<div class="paragraph">
<p>We decided to split between audio and video because they have different RTP packet structure, (non overlapping) properties, different FEC encoding and different encryption requirements but the basic flow is the same for both plugins.</p>
</div>
<div class="paragraph">
<p>Given that this is a direct transformation from one input buffer to another output buffer we decided to use <a href="https://gstreamer.freedesktop.org/documentation/base/gstbasetransform.html?gi-language=c">GstBaseTransform</a> as the base class.
This will implement some boilerplate code for us so that we can focus on the main <a href="https://gstreamer.freedesktop.org/documentation/base/gstbasetransform.html?gi-language=c#GstBaseTransformClass::transform"><code>_transform</code></a> virtual method implementation.</p>
</div>
<div class="paragraph">
<p>Following the nomenclature used in the <a href="https://gstreamer.freedesktop.org/documentation/rtp/index.html?gi-language=c">official GStreamer RTP plugins</a> we called them <code>rtpmoonlightpay_video</code> and <code>rtpmoonlightpay_audio</code> as in RTP Moonlight Payloader video/audio.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_code"><a class="anchor" href="#_code"></a>Code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>GStreamer uses GObjects: a mechanism to retrofit Objects into C.
I suggest you to get a bit familiar with it before diving into the code; <a href="http://sgros.blogspot.com/2016/01/few-tips-about-gobject-for-oo.html">here&#8217;s a great and simple tutorial</a>.</p>
</div>
<div class="paragraph">
<p>Following the official docs at <a href="https://gstreamer.freedesktop.org/documentation/plugin-development/basics/boiler.html?gi-language=c">Plugin Write&#8217;s Guide</a> we started off with the <a href="https://github.com/GStreamer/gst-plugins-bad/blob/ca8068c6d793d7aaa6f2e2cc6324fdedfe2f33fa/tools/gst-element-maker">official bash script</a> that creates the boilerplate code from the selected base class; namely:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/games-on-whales/wolf/blob/HEAD/src/streaming/streaming/gst-plugin/gstrtpmoonlightpay_video.hpp">gstrtpmoonlightpay_video.hpp</a> and <a href="https://github.com/games-on-whales/wolf/blob/HEAD/src/streaming/streaming/gst-plugin/gstrtpmoonlightpay_video.cpp">gstrtpmoonlightpay_video.cpp</a> contain all the boilerplate code needed to setup a plugin, property definitions, etc.</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/games-on-whales/wolf/blob/HEAD/src/streaming/streaming/gst-plugin/gstrtpmoonlightpay_audio.hpp">gstrtpmoonlightpay_audio.hpp</a> and <a href="https://github.com/games-on-whales/wolf/blob/HEAD/src/streaming/streaming/gst-plugin/gstrtpmoonlightpay_audio.cpp">gstrtpmoonlightpay_audio.cpp</a> for audio.</p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="https://github.com/games-on-whales/wolf/blob/HEAD/src/streaming/streaming/gst-plugin/video.hpp">video.hpp</a> contains all the functions that turns a linear buffer of data into a list of correctly formed RTP packets.</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/games-on-whales/wolf/blob/HEAD/src/streaming/streaming/gst-plugin/audio.hpp">audio.hpp</a> same for audio</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
    <p>Copyright &#169; Alessandro Beltramo and <a href="https://github.com/games-on-whales">GOW</a> contributors.</p>
    <p>Except where otherwise noted, docs are licensed under the <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution-ShareAlike 4.0 International</a> (CC BY-SA 4.0).</p>
</footer><script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script async src="../../_/js/vendor/tabs.js"></script>
<script src="../../_/js/vendor/lunr.js"></script>
<script src="../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../.." data-snippet-length="100" data-stylesheet="../../_/css/search.css"></script>
<script async src="../../search-index.js"></script>
  </body>
</html>
