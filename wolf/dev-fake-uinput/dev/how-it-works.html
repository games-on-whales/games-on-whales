<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>How does it work? :: Games On Whales</title>
    <link rel="canonical" href="https://games-on-whales.github.io/wolf/stable/dev/how-it-works.html">
    <meta name="generator" content="Antora 3.1.7">
<link rel="stylesheet" href="../../../_/css/site.css">
<link rel="stylesheet" href="../../../_/css/vendor/tabs.css">
<link rel="stylesheet" href="../../../_/css/site-extra.css">
  </head>
  <body class="article">
<header class="header">
    <div class="fancy-stripe"></div>
    <nav class="navbar">
        <div class="navbar-brand">
            <a class="navbar-item" href="https://games-on-whales.github.io">Games On Whales</a>
                <div class="navbar-item search hide-for-print">
                    <div id="search-field" class="field">
                        <input id="search-input" type="text" placeholder="Search the docs">
                    </div>
                </div>
            <button class="navbar-burger" data-target="topbar-nav">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
        <div id="topbar-nav" class="navbar-menu">
            <div class="navbar-end">
                <div class="navbar-item has-dropdown is-hoverable">
                    <a class="navbar-link" href="#">Projects</a>
                    <div class="navbar-dropdown">
                        <a class="navbar-item" href="https://games-on-whales.github.io/wolf/stable/">Wolf</a>
                        <a class="navbar-item" href="https://github.com/games-on-whales/inputtino">inputtino</a>
                        <a class="navbar-item" href="https://github.com/games-on-whales/gst-wayland-display">gst-wayland-display</a>
                        <a class="navbar-item" href="https://games-on-whales.github.io/gow/">Games on Whales</a>
                    </div>
                </div>
                <div class="navbar-item has-dropdown is-hoverable">
                    <a class="navbar-link" href="#">Community</a>
                    <div class="navbar-dropdown">
                        <a class="navbar-item" href="https://discord.gg/kRGUDHNHt2">Discord</a>
                        <a class="navbar-item" href="https://github.com/games-on-whales">Github</a>
                        <a class="navbar-item" href="https://opencollective.com/games-on-whales/donate">Donate</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>
</header>
<div class="body">
<div class="nav-container" data-component="wolf" data-version="dev-fake-uinput">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../index.html">wolf</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">User guide</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../user/quickstart.html">Quickstart</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../user/configuration.html">Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../user/gstreamer.html">Gstreamer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../user/troubleshooting.html">Troubleshooting</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Developer guide</span>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="how-it-works.html">How does it work?</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="manual_build.html">Dev environment setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="code-structure.html">Code Structure</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="gstreamer.html">GStreamer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="wayland.html">Headless Wayland</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="fake-udev.html">Hotplug in Docker</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../protocols/index.html">Moonlight Protocols</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../protocols/http-pairing.html">HTTP/S Pairing</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../protocols/rtsp.html">RTSP</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">RTP</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../protocols/rtp-video.html">Video (H.264/HEVC)</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../protocols/rtp-opus.html">Audio (Opus)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../protocols/control-specs.html">Control (via ENET)</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../protocols/input-data.html">Input Data</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">wolf</span>
    <span class="version">dev-fake-uinput</span>
  </div>
  <ul class="components">
    <li class="component">
      <div class="title"><a href="../../../gow/index.html">gow</a></div>
    </li>
    <li class="component is-current">
      <div class="title"><a href="../../stable/index.html">wolf</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../stable/index.html">stable</a>
        </li>
        <li class="version">
          <a href="../../dev-zero-copy/index.html">dev-zero-copy</a>
        </li>
        <li class="version">
          <a href="../../dev-wolfapi/index.html">dev-wolfapi</a>
        </li>
        <li class="version">
          <a href="../../dev-tracy/index.html">dev-tracy</a>
        </li>
        <li class="version">
          <a href="../../dev-nix/index.html">dev-nix</a>
        </li>
        <li class="version is-current">
          <a href="../index.html">dev-fake-uinput</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../stable/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">wolf</a></li>
    <li>Developer guide</li>
    <li><a href="how-it-works.html">How does it work?</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">dev-fake-uinput</button>
  <div class="version-menu">
    <a class="version" href="../../stable/dev/how-it-works.html">stable</a>
    <a class="version" href="../../dev-zero-copy/dev/how-it-works.html">dev-zero-copy</a>
    <a class="version" href="../../dev-wolfapi/dev/how-it-works.html">dev-wolfapi</a>
    <a class="version is-missing" href="../../dev-tracy/index.html">dev-tracy</a>
    <a class="version" href="../../dev-nix/dev/how-it-works.html">dev-nix</a>
    <a class="version is-current" href="how-it-works.html">dev-fake-uinput</a>
  </div>
</div>
<div class="edit-this-page"><a href="https://github.com/games-on-whales/wolf/edit/dev-fake-uinput/docs/modules/dev/pages/how-it-works.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">How does it work?</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Wolf is composed of a few independent components that, when used together, allow us to run and stream multiple graphical applications on the same server without any overlap between them.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../_images/wolf-dev-components.svg" alt="Wolf components diagram"></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_virtual_desktop"><a class="anchor" href="#_virtual_desktop"></a>Virtual desktop</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to create virtual desktops on-demand, we&#8217;ve created a custom (micro) Wayland compositor: <a href="https://github.com/games-on-whales/gst-wayland-display">gst-wayland-display</a>.
It&#8217;s based on <a href="https://github.com/Smithay/smithay">Smithay</a>, coded in Rust and exposes both a standalone GStreamer plugin and an easy-to-use C API.<br>
The main benefit of this solution is that our compositor will then expose the raw framebuffer so that Wolf can feed that directly to the video encoding pipeline.
You can read more about it in <a href="wayland.html" class="xref page">Headless Wayland</a>.</p>
</div>
<div class="paragraph">
<p>To keep things simple, our Wayland compositor doesn&#8217;t support XWayland, for containers that need it (like Steam) we use <a href="https://github.com/ValveSoftware/gamescope">Gamescope</a> which can be run as a Wayland client, and it&#8217;ll provide XWayland support to the downstream app.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_virtual_audio"><a class="anchor" href="#_virtual_audio"></a>Virtual audio</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Audio doesn&#8217;t need any HW acceleration, it&#8217;s fairly trivial to run PulseAudio as a standalone container and use <code>libpulse</code> in order to create virtual audio sink on-demand.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_virtual_input_devices"><a class="anchor" href="#_virtual_input_devices"></a>Virtual input devices</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Creating and managing virtual devices is handled by <a href="https://github.com/games-on-whales/inputtino">inputtino</a>: a small library that abstracts away the complexities of managing <code>uinput</code> (and <code>uhid</code>) to create virtual input devices.<br></p>
</div>
<div class="paragraph">
<p>Virtual devices created by inputtino will be visible on the host system and can potentially break the host isolation that we&#8217;re trying to achieve.
In order to avoid this, we encourage users to install a set of udev rules that will restrict access to these devices to a specific group (e.g. <code>input</code>) and move mouse and keyboard to a different seat (see <a href="../user/quickstart.html#_virtual_devices_support" class="xref page">user:quickstart.adoc#_virtual_devices_support</a>).</p>
</div>
<div class="paragraph">
<p>You can read a more detailed explanation into why we&#8217;ve added <code>uhid</code> and how gyro/acceleration is achieved <a href="https://github.com/games-on-whales/inputtino/blob/stable/src/uhid/README.adoc">here</a></p>
</div>
<div class="sect2">
<h3 id="_support_hotplug_via_fake_udev"><a class="anchor" href="#_support_hotplug_via_fake_udev"></a>Support hotplug via fake-udev</h3>
<div class="paragraph">
<p>Some devices like mouse and keyboard are always present and will be automatically created and setup before starting the application.
Other devices can be hotplugged whilst the streaming is running; for example, a gamepad can be plugged in after the game has started.<br>
Special care is needed in order to safely mount these new devices in the app container and to make them available to the running application, there&#8217;s an in-depth article about it here: <a href="fake-udev.html" class="xref page">Hotplug in Docker</a><br></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_running_applicationsgames"><a class="anchor" href="#_running_applicationsgames"></a>Running applications/games</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We run applications in a containerised environment, this way we can ensure that the application will not interfere with the host system (and with other running apps) and that it will have access only to the virtual devices that we&#8217;ve created.<br>
We have a set of pre-built containers that are optimised to work with our flow in <a href="https://github.com/games-on-whales/gow">games-on-whales/gow</a>. Generally, though, most of the GUI applications should work inside a container that can then be streamed via Wolf.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_streaming"><a class="anchor" href="#_streaming"></a>Streaming</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We use <a href="https://gstreamer.freedesktop.org/">GStreamer</a> to encode the video and audio streams and send them to the client. We have automatic support for HW acceleration using CUDA, QuickSync and VAAPI but thanks to GStreamer we can easily add more encoders into the mix, without having to write a single line of code! The full encoding pipeline is described in a string that can be overridden by users just by changing the <code>config.toml</code> file.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve implemented a couple of custom GStreamer plugins in order to properly split, RTP encode and add <a href="https://en.wikipedia.org/wiki/Error_correction_code">FEC</a> to the resulting buffers into the format that Moonlight expects; they live in here: <a href="https://github.com/games-on-whales/wolf/tree/stable/src/moonlight-server/gst-plugin">src/moonlight-server/gst-plugin</a>.</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
    <div>
        <a href="https://opencollective.com/games-on-whales/donate" target="_blank">
            <img src="https://opencollective.com/webpack/donate/button@2x.png?color=white" width=250/>
        </a>
    </div>
    <p>Copyright &#169; ABeltramo and <a href="https://github.com/games-on-whales">GOW</a> contributors.</p>
    <p>Except where otherwise noted, docs are licensed under the <a href="https://creativecommons.org/licenses/by/4.0/">Creative
        Commons Attribution-ShareAlike 4.0 International</a> (CC BY-SA 4.0).</p>
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
<script async src="../../../_/js/vendor/tabs.js"></script>
<script src="../../../_/js/vendor/lunr.js"></script>
<script src="../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../.." data-snippet-length="100" data-stylesheet="../../../_/css/search.css"></script>
<script async src="../../../search-index.js"></script>
  </body>
</html>
