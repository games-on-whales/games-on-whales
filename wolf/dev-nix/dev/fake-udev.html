<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Hotplug in Docker :: Games On Whales</title>
    <link rel="canonical" href="https://games-on-whales.github.io/wolf/stable/dev/fake-udev.html">
    <meta name="generator" content="Antora 3.1.7">
<link rel="stylesheet" href="../../../_/css/site.css">
<link rel="stylesheet" href="../../../_/css/vendor/tabs.css">
<link rel="stylesheet" href="../../../_/css/site-extra.css">
  </head>
  <body class="article">
<header class="header">
    <div class="fancy-stripe"></div>
    <nav class="navbar">
        <div class="navbar-brand">
            <a class="navbar-item" href="https://games-on-whales.github.io">Games On Whales</a>
                <div class="navbar-item search hide-for-print">
                    <div id="search-field" class="field">
                        <input id="search-input" type="text" placeholder="Search the docs">
                    </div>
                </div>
            <button class="navbar-burger" data-target="topbar-nav">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
        <div id="topbar-nav" class="navbar-menu">
            <div class="navbar-end">
                <div class="navbar-item has-dropdown is-hoverable">
                    <a class="navbar-link" href="#">Projects</a>
                    <div class="navbar-dropdown">
                        <a class="navbar-item" href="https://games-on-whales.github.io/wolf/stable/">Wolf</a>
                        <a class="navbar-item" href="https://github.com/games-on-whales/inputtino">inputtino</a>
                        <a class="navbar-item" href="https://github.com/games-on-whales/gst-wayland-display">gst-wayland-display</a>
                        <a class="navbar-item" href="https://games-on-whales.github.io/gow/">Games on Whales</a>
                    </div>
                </div>
                <div class="navbar-item has-dropdown is-hoverable">
                    <a class="navbar-link" href="#">Community</a>
                    <div class="navbar-dropdown">
                        <a class="navbar-item" href="https://discord.gg/kRGUDHNHt2">Discord</a>
                        <a class="navbar-item" href="https://github.com/games-on-whales">Github</a>
                        <a class="navbar-item" href="https://opencollective.com/games-on-whales/donate">Donate</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>
</header>
<div class="body">
<div class="nav-container" data-component="wolf" data-version="dev-nix">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../index.html">wolf</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">User guide</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../user/overview.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../user/quickstart.html">Quickstart</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../user/configuration.html">Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../user/gstreamer.html">Gstreamer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../user/troubleshooting.html">Troubleshooting</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Developer guide</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="manual_build.html">Dev environment setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="code-structure.html">Code Structure</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="gstreamer.html">GStreamer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="wayland.html">Headless Wayland</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="fake-udev.html">Hotplug in Docker</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../protocols/index.html">Moonlight Protocols</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../protocols/http-pairing.html">HTTP/S Pairing</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../protocols/rtsp.html">RTSP</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">RTP</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../protocols/rtp-video.html">Video (H.264/HEVC)</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../protocols/rtp-opus.html">Audio (Opus)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../protocols/control-specs.html">Control (via ENET)</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../protocols/input-data.html">Input Data</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">wolf</span>
    <span class="version">dev-nix</span>
  </div>
  <ul class="components">
    <li class="component">
      <div class="title"><a href="../../../gow/index.html">gow</a></div>
    </li>
    <li class="component is-current">
      <div class="title"><a href="../../stable/index.html">wolf</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../stable/index.html">stable</a>
        </li>
        <li class="version">
          <a href="../../dev-tracy/index.html">dev-tracy</a>
        </li>
        <li class="version is-current">
          <a href="../index.html">dev-nix</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../stable/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">wolf</a></li>
    <li>Developer guide</li>
    <li><a href="fake-udev.html">Hotplug in Docker</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">dev-nix</button>
  <div class="version-menu">
    <a class="version" href="../../stable/dev/fake-udev.html">stable</a>
    <a class="version" href="../../dev-tracy/dev/fake-udev.html">dev-tracy</a>
    <a class="version is-current" href="fake-udev.html">dev-nix</a>
  </div>
</div>
<div class="edit-this-page"><a href="https://github.com/games-on-whales/wolf/edit/dev-nix/docs/modules/dev/pages/fake-udev.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Hotplug in Docker</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>We would like to achieve two goals here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Be able to plug (and unplug) devices into our applications running inside Docker containers</p>
</li>
<li>
<p>Achieve full isolation: we don&#8217;t want to overlap devices between different containers</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/hotplug_demo.gif" alt="Hotplug demo gif">
</div>
<div class="title">Figure 1. A working example: connecting a joypad to the client triggers the right detection in RetroArch running in the server.</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mount_virtual_devices"><a class="anchor" href="#_mount_virtual_devices"></a>Mount virtual devices</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Wolf creates virtual devices on-demand based on the packets that are received from Moonlight clients over the <a href="../protocols/control-specs.html" class="xref page">control stream</a>.<br>
When a new virtual device is created, we have to "mount" it inside the right running Docker container since, in order to achieve isolation, we can&#8217;t run them with the <a href="https://docs.docker.com/engine/reference/commandline/run/#privileged">privileged flag</a>.</p>
</div>
<div class="paragraph">
<p>Normally, Docker assigns devices available to a container at creation time.
Fortunately, it supports a more permissive rule that allows to access a wider range of devices based on the device <a href="https://www.oreilly.com/library/view/linux-device-drivers/0596000081/ch03s02.html">major:minor</a>.
By adding the <a href="https://docs.docker.com/engine/reference/commandline/run/#device-cgroup-rule">--device-cgroup-rule</a> we can then call <code>mknod</code> <sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup> from inside the container in order to mount the virtual devices on-demand from the outside.</p>
</div>
<div class="listingblock">
<div class="title">Example Docker command issued by Wolf</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">docker exec -it &lt;App_Container&gt; sh -c "mknod /dev/input/&lt;device name&gt; c &lt;major&gt;:&lt;minor&gt;"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_if_a_tree_falls_in_the_forest_does_it_make_a_sound"><a class="anchor" href="#_if_a_tree_falls_in_the_forest_does_it_make_a_sound"></a>If a tree falls in the forest, does it make a sound?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ve mounted the right device into the right container, still, no application is picking it up <sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>.
We have to trigger some kind of "event" in order to advertise that a new device has arrived, turns out those kind of events are generated by <strong>udev</strong>.</p>
</div>
<div class="listingblock">
<div class="title">An example udev event when you plug a joypad</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">UDEV  [3588.199301] add      /devices/pci0000:00/0000:00:01.3/0000:02:00.0/usb1/1-1/1-1:1.3/0003:054C:0CE6.0007/input/input20/js0 (input)
ACTION=add
SUBSYSTEM=input
DEVNAME=/dev/input/js0
ID_BUS=usb
ID_MODEL=Wireless_Controller
ID_SERIAL=Sony_Interactive_Entertainment_Wireless_Controller
ID_VENDOR=Sony_Interactive_Entertainment
ID_VENDOR_ENC=Sony\x20Interactive\x20Entertainment
ID_VENDOR_ID=054c
ID_REVISION=0100
ID_TYPE=hid
ID_USB_VENDOR_ID=054c
ID_USB_REVISION=0100
ID_USB_TYPE=hid
ID_USB_DRIVER=usbhid
MAJOR=13
MINOR=0</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_use_udev_from_the_host"><a class="anchor" href="#_use_udev_from_the_host"></a>Use udev from the host</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first approach is to just pass the udev socket (and db files, more on this later) from the host.
Sure, every application will get the event that a new device has been plugged, so this kind of defeats isolation; but since we are mounting only in one container, this should still work, right?</p>
</div>
<div class="paragraph">
<p>Unfortunately, there&#8217;s another issue: when Wolf creates a new virtual device, it will in turn automatically trigger the udev event to be "broadcast" to every listening application and if this happens before we are able to <code>mknod</code> the device it&#8217;ll result in an application that can&#8217;t access the device that we&#8217;ve created.</p>
</div>
<div class="paragraph">
<p>We want to be able to be in control of exactly when these events will be sent so that the flow is as follows:</p>
</div>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/plantuml/svg/eNpdjjEKwzAMRXedQhfoBTwUPGbpFjy7iQICRzaO5Fy_cSgUd33vf_5X1kQOX3TiSo0Xwi3lE6JpFtvfVAFKrMoLlyiKIacN44FhoMZSTDufBu5L6dCP4Wun0xkAwuM5OVwqRSVsXNVi-v7ozjvcs12dPzXf6iBZUX7HqZHoB_gNSGs=" alt="The order here matters, the udev events *must* be sent after the mount">
</div>
<div class="title">Figure 2. The order here matters, the udev events <strong>must</strong> be sent after the mount</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_generating_udev_events"><a class="anchor" href="#_generating_udev_events"></a>Generating udev events</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since we have no control over udev and we can&#8217;t mount a device before it&#8217;s created we have to replicate the events that are generated by it and broadcast them in the same way to all listening applications.<br>
First, let&#8217;s take a step back; how are application communicating with udev?</p>
</div>
<div class="sect2">
<h3 id="_udev_internals"><a class="anchor" href="#_udev_internals"></a>Udev internals</h3>
<div class="quoteblock">
<blockquote>
Though udev runs in userspace, it is highly entangled with the Linux kernel.
The first entry that recognizes device insertion/deletion events is surely the Linux kernel.
While there were no mechanisms for the Linux kernel to push notifications to userspace processes (with <code>ioctl()</code> the kernel can only provide responses for the corresponding requests from userspace processes), <strong>netlink IPC mechanism</strong> emerged and currently it is available for the kernel to send a notification first.
</blockquote>
<div class="attribution">
&#8212; https://insujang.github.io/2018-11-27/udev-device-manager-for-the-linux-kernel-in-userspace/
</div>
</div>
<div class="paragraph">
<p>Normally udevd does the following steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Listens for kernel events via the <code>netlink</code> socket (<code>GROUP_KERNEL</code>)</p>
</li>
<li>
<p>When it receives a new device event, it&#8217;ll run all the rules that are defined</p>
</li>
<li>
<p>Send back the "augmented" message via another <code>netlink</code> socket (<code>GROUP_UDEV</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The two different groups are crucial, whilst every user application can listen the <code>GROUP_KERNEL</code> events only the kernel can be the origin for those messages. <code>GROUP_UDEV</code> being an user space group instead can be "impersonated" by any user space application <sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup>.</p>
</div>
<div class="paragraph">
<p>Since this will run in Docker there&#8217;s an additional mechanism that we have to keep in mind: <strong>network namespaces</strong>. Since udevd communicates via <code>netlink</code> a container that doesn&#8217;t run with <code>--network=host</code> will not receive those events; we&#8217;ll have to run our custom udev sender inside the container network namespace in order to achieve full isolation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_faking_udev"><a class="anchor" href="#_faking_udev"></a>Faking udev</h3>
<div class="paragraph">
<p>There are 3 main components that needs to be "faked" in order for tricking programs that are using <code>libudev</code> into using our fake events:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>create a file under <code>/run/udev/control</code> this is not used for anything else apart from detection that udev is present AFAIU.</p>
</li>
<li>
<p>send a valid <code>NETLINK_KOBJECT_UEVENT</code> event via <code>netlink</code> using <code>GROUP_UDEV</code></p>
</li>
<li>
<p>generate the appropriate DB entries in <code>/run/udev/data/</code></p>
<div class="ulist">
<ul>
<li>
<p>these are just plain text files where the filename is just <code>c&lt;major&gt;:&lt;minor&gt;</code> and the content is roughly the same as the event message payload</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The result of all this is our little CLI utility called <code>fake-udev</code> which we&#8217;ll install into our containers and call with our custom-generated events after <code>mknod</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">echo -ne \"ACTION=add\\0DEVNAME=input/bomb\\0DEVPATH=/devices/bomb\\0SEQNUM=1234\\0SUBSYSTEM=input\\0\" | base64 | sudo fake-udev

# `udevadm monitor` should print something like:
UDEV  [3931.403835] add      /devices/bomb  (input)</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_putting_it_all_together"><a class="anchor" href="#_putting_it_all_together"></a>Putting it all together</h2>
<div class="sectionbody">
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/plantuml/svg/eNptjkEKAyEQBO_ziv5APuAhYMg5V8_GnYUBV0VH9_txQQiBXKuoplU0ssGLT2w8JDD2mE_yXXPqx5srUfFVJUjxSeFy3OEb3A-1pVzQEpG73Z1BqOyVMaRq93EtX84aHLnP5K9aWZ8Qzwc4aRVuSzZOG9L3J4_pP7cGQTk=" alt="Diagram">
</div>
</div>
<div class="paragraph">
<p>These steps will finally achieve proper hotplug detection by the applications that are running inside a Docker container without exposing any udev event/file from the host filesystem.</p>
</div>
<div class="paragraph">
<p>Luckily, reversing the steps is enough to also correctly unplug devices.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_references"><a class="anchor" href="#_references"></a>References</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First off, a huge thanks goes to <a href="https://github.com/JohnCMcDonough">John McDonough</a> for all the help in figuring most of this stuff out and for leading the way with his prototype <a href="https://github.com/JohnCMcDonough/virtual-gamepad">JohnCMcDonough/virtual-gamepad</a>.</p>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. This obviously requires also the <code>MKNOD</code> capability to be enabled (<code>--cap-add MKNOD</code>)
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. Some application might react to the new device if it&#8217;s using <code>inotify</code>, unfortunately, this is not the default behaviour in most apps/games
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. Given enough permissions, that&#8217;s why our fake udev runs as <code>root</code>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
    <div>
        <a href="https://opencollective.com/games-on-whales/donate" target="_blank">
            <img src="https://opencollective.com/webpack/donate/button@2x.png?color=white" width=250/>
        </a>
    </div>
    <p>Copyright &#169; ABeltramo and <a href="https://github.com/games-on-whales">GOW</a> contributors.</p>
    <p>Except where otherwise noted, docs are licensed under the <a href="https://creativecommons.org/licenses/by/4.0/">Creative
        Commons Attribution-ShareAlike 4.0 International</a> (CC BY-SA 4.0).</p>
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
<script async src="../../../_/js/vendor/tabs.js"></script>
<script src="../../../_/js/vendor/lunr.js"></script>
<script src="../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../.." data-snippet-length="100" data-stylesheet="../../../_/css/search.css"></script>
<script async src="../../../search-index.js"></script>
  </body>
</html>
